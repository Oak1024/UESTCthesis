% !Mode:: "TeX:UTF-8"

\chapter{USB转接器的整体方案设计}
\section{USB简介}
随着电子科技的发展与应用，各种计算机外围接口不断推陈出新，USB接口已经成为现今个人计算机上最重要的接口之一，各种电子消费产品也逐渐配置这种接口。USB接口是速度比较高的串行接口，具有较广阔的发展前景和应用潜力。USB适用于低档外设与主机之间的高速数据传输。从USB问世至今，USB在不断的自我完善，并走向成熟。从普通计算机用户、计算机工程师、到硬件芯片生产厂商，都已经完全认可了USB。

与其它通信接口比较，USB接口的最大特点是易于使用，这也是USB的主要设计目标。作为一种高速总线接口，USB适用于多种设备，如数码相机、MP3播放机、高速数据采集设备等。易于使用还表现在USB接口支持热插拔，并且所有的配置过程都由系统自动完成，无需用户干预。USB接口支持1.5Mb/s（低速）和12Mb/s（全速）的数据传输速率，扣除用于总线状态、控制和错误监测等的数据传输，USB的最大理论传输速率仍达1.2Mb/s或9.6Mb/s，远高于一般的串行总线接口。USB接口芯片价格低廉，这也大大促进USB设备的开发与应用。 
在进行一个USB设备开发之前，首先要根据具体使用要求选择合适的USB控制器。目前，市场上供应的USB控制器主要有两种：带USB接口的单片机（MCU）或纯粹的USB接口芯片。带USB接口的单片机从应用上又可以分成两类，一类是从底层设计专用于USB控制的单片机，另一类是增加了USB接口的普通单片机，如Cypress公司的EZ－USB（基于8051），选择这类USB控制器的最大好处在于开发者对系统结构和指令集非常熟悉，开发工具简单，但对于简单或低成本系统。其价格因素也是在实际选择过程中需要考虑的因素。纯粹的USB接口芯片仅处理USB通信，必须有一个外部微处理器来进行协议处理和数据交换。这类典型产品有Philips公司的PDIUSBD12（并行接口），NS公司USBN9603/9604（并行接口），NetChip公司的NET2888等。USB接口芯片的主要特点是价格便宜、接口方便、可靠性高，尤其适合于产品的改型设计（硬件上仅需对并行总线和中断进行改动，软件则需要增加微处理器的USB中断处理和数据交换程序，PC机的USB接口通信程序，无需对原有产品系统结构作很大的改动）\citeup{USBcomplete}。
\section{USB体系及协议}
USB以USB主机为核心，以外围的USB设备为功能，组成了USB系统模型。主机是USB的核心，每次USB数据通信都必须是由USB主机来发起的，主机管理着USB设备。USB物理上是一个含有两条电源线（VCC，GND）和两条以差分方式产生信号的线（D+，D-），传输率可达12Mbps的串行接口，一个PC主机可以连接多达127个外围设备。USB协议是以令牌包为主的通信协议，12Mbps的总线带宽被分割成1ms的帧，所有任务以时分传输（TDM）来分享总线。

 
\subsection{USB体系概述}
\subsubsection{USB系统描述}
一个USB系统主要被定义为三个部分：
\begin{enumerate}
\item USB的互连
\item USB的设备
\item USB的主机
\end{enumerate}

USB的互连是指USB设备与主机之间进行连接和通信的操作，主要包括以下几方面： 

总线的拓扑结构：USB设备与主机之间的各种连接方式； 

\begin{enumerate}
\item 内部层次关系
根据性能叠置，USB的任务被分配到系统的每一个层次
\item 数据流模式
描述了数据在系统中通过USB从产生方到使用方的流动方式
\item USB的调度
USB提供了一个共享的连接。对可以使用的连接进行了调度以支持同步数据传输，并且避免的优先级判别的开销
\end{enumerate}

USB连接了USB设备和USB主机，USB的物理连接是有层次性的星型结构。每个网络集线器是在星型的中心，每条线段是点点连接。从主机到集线器或其功能部件，或从集线器到集线器或其功能部件，从图\ref{USBjinzita}中可看出USB系拓扑结构。

其中，USB集线器Hub是一组设备的连接点，主机中有一个被嵌入的Hub叫根Hub（root Hub）。主机端通常是指PC主机或是另外再附加USB 端口的扩充卡，主机通过根Hub提供若干个连接点。集线器除了扩增系统的连接点外，还负责中继（repeat）上游或下游的信号以及控制各个下游端口的电源管理。 

当PC上电时，所有USB设备与Hub都默认地址为0，PC机启动程序向USB查询，地址1分配给发现的第一个设备，地址2分配给第二个设备或Hub，如此重复寻找并分配地址，直到所有设备赋完地址，并加载相应的的驱动程序。 

当设备突然被拔移后，PC机通过D+或D-的电压变化检测到设备被移除掉后，将其地址收回，并列入可使用的地址名单中。 

在任何USB系统中，只有一个主机。USB和主机系统的接口称作主机控制器，主机控制器可由硬件、固件和软件综合实现。根集线器是由主机系统整合的，用以提供更多的连接点。 

\pic[h]{总线的拓扑结构}{width=4in}{USBjinzita}

USB的设备如下所示: 
\begin{enumerate}
\item 网络集线器，向USB提供了更多的连接点

\item 功能器件：为系统提供具体功能，如数字的游戏杆或扬声器
\end{enumerate}

USB设备提供的USB标准接口的主要依据：     
\begin{enumerate}
\item 对USB协议的运用

\item 对标准USB操作的反馈，如设置和复位

\item 标准性能的描述性信息 
\end{enumerate}

\subsubsection{USB连接头机器供电方式}
为了避免连接错误，USB定义了两种不同规格的星形USB连接头：序列A与B连接头，其中序列A接头用来连接下游的设备。每个连接头内拥有4个针脚，其中两个是用来传递差分数据的，另两个则用于USB设备的电源供给。 

USB的供电方式有两种： 
\begin{enumerate}
\item 总线供电集线器 
电源由上游连接端口供应，最多只能从上游端消耗500mA。一个4个连接端口的集线器，每个下游端口最多消耗为100mA，外围电路消耗100mA。 
\item 自我供电集线器 
集线器本身有电源，可以提供给本身的控制器以及下游端口至少500mA的电流，集线器最多可从上游端消耗100mA。 
\end{enumerate}
\subsubsection{USB系统软硬件组成}
USB系统的软硬件资源可以分为3个层次：功能层、设备层和接口层。 

功能层提供USB设备所需的特定的功能，主机端的这个功能由用户软件和设备类驱动程序提供，而设备就由功能单元来实现。 

设备层主要提供USB基本的协议栈，执行通用的USB的各种操作和请求命令。从逻辑上讲，就是USB系统软件与USB逻辑设备之间的数据交换。 

接口层涉及的是具体的物理层，其主要实现物理信号和数据包的交互，即在主机端的USB主控制器和设备的USB总线接口之间传输实际的数据流。 

无论在软件还是硬件层次上，USB主机都处于USB系统的核心。主机系统不仅包含了用于和USB外设进行通信的USB主机控制器及用于连接的USB接口（SIE），更重要的是，主机系统是USB系统软件和USB客户软件的载体。USB主机软件系统可以分为三个部分:
\begin{enumerate}
\item 客户软件部分（CSW）
在逻辑上和外设功能部件部分进行资料的交换

\item USB系统软件部分（即HCDI）
在逻辑和实际中作为HCD 和USBD之间的接口

\item USB主机控制器软件部分（即HCD和USBD）
用于对外设和主机的所有USB有关部分的控制和管理，包括外设的SIE部分、USB资料发送接收器（Transreceiver）部分及外设的协议层等\citeup{USBcomplete}。
\end{enumerate}

\section{嵌入式实时系统简介}

\subsection{嵌入式系统}
嵌入式系统是为了满足特定需求而设计的计算系统，常见的嵌入式系统如：机顶盒，路由器等\citeup{arm0,arm1}。它们总是针对特定的需求来设计的，比如电视机顶盒用于播放网络中的电视节目(不会试图用来写文档)；网络路由器用于网络报文的正确转发(不会试图用于看电影)。这类系统通常针对特定的外部输入进行处理然后给出相应的结果。 功能相对单一(因为需求也相对
单一)，而正是因为这类系统的专用性，为了完成这一功能，嵌入式系统提供相匹配的硬件资
源，多余的硬件资源能力是浪费，而欠缺的硬件资源能力则不能够满足设定的目标，即在成
本上“恰好”满足设定的要求。

嵌入式系统的核心是由一个或几个预先编程好以用来执行少数几项任务的微处理器或者单片机组成。与通用计算机能够运行用户选择的软件不同，嵌入式系统上的软件通常是暂时不变的；所以经常称为“固件”。

国内普遍认同的嵌入式系统定义为：以应用为中心，以计算机技术为基础，软硬件可裁剪，适应应用系统对功能、可靠性、成本、体积、功耗等严格要求的专用计算机系统。

嵌入式系统是面向用户、面向产品、面向应用的，它必须与具体应用相结合才会具有生命力、才更具有优势。因此可以这样理解上述三个面向的含义，即嵌入式系统是与应用紧密结合的，它具有很强的专用性，必须结合实际系统需求进行合理的裁减利用。
\subsection{实时系统}
在嵌入式系统中，计算的逻辑结果和产生结果的时间决定了实时计算即系统的正确性。
这两点关键技术对于实时系统的正确性保证有着同等的作用。暂时舍去逻辑结果方面，单从
产生结果的时间方面考虑，我们可以把实时系统分为两类：软实时和硬实时系统。和嵌入式
系统类似，实时系统的确定性能够在给定的时间内对某一事件做出即刻的响应。从整个实时
系统的确定性来看， 要想构成这样的一个系统需要对多个事件在给定的时间内做出响应。（实
时系统并不代表着对所有输入事件具备实时响应， 而是针对指定的事件能够做出实时的响应）
在实际的应用领域，嵌入式系统被十分广泛的应用，但是对于实时性系统所使用的范围有这
样的规定：在一个系统中，只有对任务的完成时间有严格限定时，才能够涉及到系统的实时
性问题。在现实生活中的主要应用有雷达控制、军事探测、深海挖掘、实验操作控制、3D 机
器人、空中交通管制、计算机远程通信、军事指挥与控制系统等。

\section{RT-Thread简介}
实时线程操作系统 （RT -Thread）
\citeup{canrs232,qian1,qian2}
是一个稳定的开源实时操作系统。它是 RT -Thread
工作室历经 4 年的呕心沥血研究的结果。 它是一款小型的、 稳定的、 开源的实时性操作系统，
它已经在很多固定的产品上得到应用。实时线程操作系统的稳定性得到了国内数十家企业的
认证。实时线程操作系统（RT -Thread）不仅是一个单一的实时操作系统内核，它也是一个完
整的应用系统，其外围的实时、嵌入式系统相关的各个组件如图\ref{rtt}所示：
\pic[h]{实时线程操作系统（RT-Thread）}{width=5in}{rtt}

RT -Thread Kernel 内核部分是 RT -Thread 的心脏， 所有的数据处理和线程管理都发生在这
里，包括 object  Management （对象管理器），Real  time  Scheduler（实时调度器），Thread
Management（线程管理），Internet Thread Communication（线程间通信）等的微小内核实现。
最小的内核只有 1k  RAM 和 4k  ROM。内核库能够保证内核独立的运作。为了方便对各个平
台的移植工作， 内核提供了 CPLI 以及相应的板级支持包。 这些支持包通常由两个汇编文件组
成，一个是用来进行系统启动初始化的文件，另一个是用来对线程进行上下文切换的文件，
他们都是以 C 源文件的形式存在，方便移植和更改。















